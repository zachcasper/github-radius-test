# Radius deployment workflow
# Generated by rad init - do not edit manually
#
# CUSTOMIZATION GUIDE:
#
# To add a scheduled cleanup (e.g., destroy dev environments nightly):
#
#   on:
#
#     schedule:
#
#       - cron: '0 2 * * *'
#
# 
#
# GitHub Secrets are available in steps via ${{ secrets.SECRET_NAME }}

name: Radius destroy
run-name: Radius destroy for ${{ inputs.application }} in ${{ inputs.environment }} environment
"on":
    workflow_dispatch:
        inputs:
            application:
                description: Application name to destroy
                required: true
                type: string
            environment:
                description: Target GitHub Environment name
                required: true
                type: string
permissions:
    actions: read
    contents: write
    id-token: write
concurrency:
    group: radius-${{ inputs.application }}-${{ inputs.environment }}
jobs:
    destroy:
        name: Destroy Application
        runs-on: ubuntu-latest
        environment: ${{ inputs.environment }}
        steps:
            - name: Checkout Radius source
              uses: actions/checkout@v4
              with:
                path: radius-src
                ref: ${{ vars.RADIUS_REF || 'main' }}
                repository: ${{ vars.RADIUS_REPO || 'radius-project/radius' }}
            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                cache: "true"
                go-version-file: radius-src/go.mod
            - name: Build Radius CLI
              run: cd radius-src && go build -o /usr/local/bin/rad ./cmd/rad
            - name: Checkout application repository
              uses: actions/checkout@v4
              with:
                path: app
            - name: Clone resource types repository
              run: |-
                # Parse RADIUS_RESOURCE_TYPES_REPO URL (format: https://github.com/<owner>/<repo>/tree/<branch>)
                REPO_PATH=$(echo "$RADIUS_RESOURCE_TYPES_REPO" | sed 's|https://github.com/||' | sed 's|/tree/.*||')
                BRANCH=$(echo "$RADIUS_RESOURCE_TYPES_REPO" | sed 's|.*/tree/||')

                git clone --depth 1 --branch "$BRANCH" "https://github.com/${REPO_PATH}.git" resource-types

                # Copy bicepconfig.json and Bicep extension archives to app directory
                # so rad deploy can resolve Bicep extensions (Bicep searches parent dirs from .bicep file)
                cp resource-types/default-config/bicepconfig.json app/
                cp resource-types/default-config/*.tgz app/
              env:
                RADIUS_RESOURCE_TYPES_REPO: ${{ vars.RADIUS_RESOURCE_TYPES_REPO }}
            - name: Install k3d
              run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
            - name: Create k3d cluster
              run: k3d cluster create radius-ephemeral --volume $GITHUB_WORKSPACE/app:/github_workspace
            - name: Export kubeconfig
              run: k3d kubeconfig get radius-ephemeral > /tmp/kubeconfig.yaml
            - name: Install Radius control plane
              run: cd app && rad install kubernetes --skip-contour-install --set dashboard.enabled=false ${RADIUS_IMAGE_REGISTRY:+--set global.imageRegistry=$RADIUS_IMAGE_REGISTRY} ${RADIUS_IMAGE_TAG:+--set global.imageTag=$RADIUS_IMAGE_TAG}
              env:
                KUBECONFIG: /tmp/kubeconfig.yaml
                RADIUS_IMAGE_REGISTRY: ${{ vars.RADIUS_IMAGE_REGISTRY }}
                RADIUS_IMAGE_TAG: ${{ vars.RADIUS_IMAGE_TAG }}
            - name: Wait for Radius and create resource group
              run: |-
                echo "Waiting for Radius control plane to be ready..."
                for i in $(seq 1 30); do
                  if rad group create github 2>/dev/null; then
                    echo "Radius control plane is ready, resource group created."
                    exit 0
                  fi
                  echo "Control plane not ready yet, retrying in 5s... ($i/30)"
                  sleep 5
                done
                echo "Timed out waiting for Radius control plane"
                exit 1
              env:
                KUBECONFIG: /tmp/kubeconfig.yaml
            - name: Register resource types
              run: |-
                cd resource-types/default-config
                for def_file in $(yq -r '.types[].definitionLocation' types.yaml); do
                  echo "Registering resource type from $def_file..."
                  rad resource-type create --from-file "$def_file"
                done
              env:
                KUBECONFIG: /tmp/kubeconfig.yaml
            - name: Create environment
              run: rad env create ${{ inputs.environment }} --group github
              env:
                KUBECONFIG: /tmp/kubeconfig.yaml
            - name: Configure cloud credentials
              id: auth
              run: |-
                # Detect provider from environment variables
                if [ -n "$AZURE_CLIENT_ID" ]; then
                  echo "provider=azure" >> $GITHUB_OUTPUT
                elif [ -n "$AWS_IAM_ROLE_NAME" ]; then
                  echo "provider=aws" >> $GITHUB_OUTPUT
                else
                  echo "No cloud provider credentials found in environment"
                  exit 1
                fi
              env:
                AWS_IAM_ROLE_NAME: ${{ vars.AWS_IAM_ROLE_NAME }}
                AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
            - name: Azure Login
              uses: azure/login@v2
              with:
                client-id: ${{ vars.AZURE_CLIENT_ID }}
                subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
                tenant-id: ${{ vars.AZURE_TENANT_ID }}
              if: steps.auth.outputs.provider == 'azure'
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-region: ${{ vars.AWS_REGION }}
                role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_IAM_ROLE_NAME }}
              if: steps.auth.outputs.provider == 'aws'
            - name: Destroy application
              run: |-
                cd app
                rad app delete "${{ inputs.application }}" \
                  --environment "${{ inputs.environment }}" \
                  --group github \
                  --yes
              env:
                KUBECONFIG: /tmp/kubeconfig.yaml
            - name: Record destruction results
              run: |-
                cd app
                DEPLOY_DIR=".radius/deploy/${{ inputs.application }}/${{ inputs.environment }}"

                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git add "$DEPLOY_DIR/" 2>/dev/null || true
                git commit -m "Destroy ${{ inputs.application }} from ${{ inputs.environment }}" \
                  --trailer "Radius-Action: destroy" || true
                git fetch origin ${{ github.ref_name }}
                git rebase FETCH_HEAD
                git push origin HEAD:${{ github.ref_name }}
              if: always()
