# Radius deployment workflow
# Generated by rad init - do not edit manually
#
# CUSTOMIZATION GUIDE:
#
# This workflow tests OIDC authentication to your cloud provider.
#
# It is dispatched automatically by 'rad environment create' but can also be run manually.
#
# 
#
# GitHub Secrets are available in steps via ${{ secrets.SECRET_NAME }}

name: Radius authentication test
run-name: Radius authentication test for ${{ inputs.environment }} environment
"on":
    workflow_dispatch:
        inputs:
            environment:
                description: GitHub Environment to test authentication for
                required: true
                type: string
permissions:
    contents: read
    id-token: write
jobs:
    test-auth:
        name: Test OIDC Authentication
        runs-on: ubuntu-latest
        environment: ${{ inputs.environment }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Detect provider
              id: provider
              run: |-
                if [ -n "$AZURE_CLIENT_ID" ]; then
                  echo "type=azure" >> $GITHUB_OUTPUT
                elif [ -n "$AWS_IAM_ROLE_NAME" ]; then
                  echo "type=aws" >> $GITHUB_OUTPUT
                else
                  echo "Error: No cloud provider credentials found in ${{ inputs.environment }} environment variables"
                  echo "Expected AZURE_CLIENT_ID (Azure) or AWS_IAM_ROLE_NAME (AWS)"
                  exit 1
                fi
              env:
                AWS_IAM_ROLE_NAME: ${{ vars.AWS_IAM_ROLE_NAME }}
                AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
            - name: Azure Login
              uses: azure/login@v2
              with:
                client-id: ${{ vars.AZURE_CLIENT_ID }}
                subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
                tenant-id: ${{ vars.AZURE_TENANT_ID }}
              if: steps.provider.outputs.type == 'azure'
            - name: Verify Azure authentication
              run: |-
                echo "Testing Azure OIDC authentication..."
                ACCOUNT=$(az account show --output json)
                echo "✅ Azure OIDC authentication successful!"
                echo "Subscription: $(echo $ACCOUNT | jq -r '.name')"
                echo "Tenant: $(echo $ACCOUNT | jq -r '.tenantId')"
              if: steps.provider.outputs.type == 'azure'
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-region: ${{ vars.AWS_REGION }}
                role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_IAM_ROLE_NAME }}
              if: steps.provider.outputs.type == 'aws'
            - name: Verify AWS authentication
              run: |-
                echo "Testing AWS OIDC authentication..."
                IDENTITY=$(aws sts get-caller-identity --output json)
                echo "✅ AWS OIDC authentication successful!"
                echo "Account: $(echo $IDENTITY | jq -r '.Account')"
                echo "ARN: $(echo $IDENTITY | jq -r '.Arn')"
              if: steps.provider.outputs.type == 'aws'
